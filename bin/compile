#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>
set -e

# Parse params
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# Default version
version="3.6.2"

# Read version from configured JEMALLOC_VERSION
# if [ -f $ENV_DIR/JEMALLOC_VERSION ]; then
#   version=$(cat $ENV_DIR/JEMALLOC_VERSION)
# fi

url="https://github.com/dimitri/pgloader/archive/v$version.zip"
dest="$BUILD_DIR/vendor/pgloader"

echo "-----> Vendoring pgloader $version"
echo "       Fetching $url"

cd /tmp

curl -sL $url > /tmp/pgloader.zip
unzip /tmp/pgloader.zip

ls -la /tmp

extracted="/tmp/pgloader-$version"
ls -la $extracted

remote_file() {
	local target="$1" origin="$2" sum="$3"
	local check="shasum --algorithm $(( 4 * ${#sum} )) --check"
	local filesum="$sum  $target"

	curl --location --output "$target" "$origin" && $check <<< "$filesum"
}

sbcl_checksum='22ccd9409b2ea16d4be69235c5ad5fde833452955cb24483815312d3b1d7401c'
sbcl_version='1.5.2'

remote_file "/tmp/sbcl-${sbcl_version}.tgz" "http://prdownloads.sourceforge.net/sbcl/sbcl-${sbcl_version}-x86-64-linux-binary.tar.bz2" "$sbcl_checksum"
tar --file  "/tmp/sbcl-${sbcl_version}.tgz" --extract --directory '/tmp'
( cd "/tmp/sbcl-${sbcl_version}-x86-64-linux" && ./install.sh )

cd $extracted

echo "-----> compiling with DYNSIZE=2048"
make DYNSIZE=2048 pgloader

ls -la $extracted/build/bin
mkdir -p $dest/bin
cp $extracted/build/bin/pgloader $dest/bin/pgloader
echo $version > $dest/pgloader.version
